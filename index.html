<!doctype html>
<html lang="en">

<head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/css/bootstrap.min.css" integrity="sha384-9aIt2nRpC12Uk9gS9baDl411NQApFmC26EwAOH8WgZl5MYYxFfc+NcPb1dKGj7Sk" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.13.0/css/all.min.css" integrity="sha256-h20CPZ0QyXlBuAw7A+KluUYx/3pK+c7lYEpqLTlxjYQ=" crossorigin="anonymous" />
    <link href="https://fonts.googleapis.com/css2?family=Lobster&family=PT+Sans&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'PT Sans', sans-serif;
        }
        
        h1 {
            font-family: 'Lobster', cursive;
        }
        
        .fa-grip-lines-vertical:hover {
            cursor: grab;
            color: #212529;
        }
        
        .fa-grip-lines-vertical:active {
            cursor: grabbing;
            color: #212529;
        }
        
        .fa-grip-lines-vertical {
            color: #6c757d;
        }
        
        .fa-caret-down::before {
            box-sizing: content-box !important;
        }
        
        .fa-caret-up::before {
            box-sizing: content-box !important;
        }
        
        .plus-minus {
            height: calc((1.5em + .75rem + 2px) / 2);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .plus-minus.up {
            border-top-right-radius: .25rem;
            border-bottom-right-radius: 0;
        }
        
        .plus-minus.down {
            border-bottom-right-radius: .25rem;
            border-top-right-radius: 0;
        }
    </style>
    <title>Easy Scorekeeper</title>
</head>

<body>
    <div class="container">
        <div class="jumbotron">
            <h1>Easy Scorekeeper</h1>
            <hr class="my-4 mx-0">
            <button class="btn btn-secondary" id="addContestant" type="button"><i class="fas fa-plus-circle mr-2"></i>Add Player</button>
            <button class="btn btn-secondary float-right" type="button" data-toggle="modal" data-target="#confirmDelete"><i class="fas fa-trash-alt mr-2"></i>Clear All</button>
        </div>
        <div class="row">
            <div class="col">
                <ul id="contestants" class="list-group">
                </ul>
            </div>
            <div class="col">
                <textarea class="form-control" id="scoreText"></textarea>
                <button class="btn btn-outline-dark my-3" data-clipboard-target="#scoreText">
                    <i class="fas fa-copy mr-2"></i>Copy
                </button>
            </div>
        </div>


        <div class="modal fade" id="confirmDelete" tabindex="-1" role="dialog" aria-labelledby="confirmDeleteLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="confirmDeleteLabel">Clear</h5>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                  </button>
                    </div>
                    <div class="modal-body">
                        <i class="fas fa-exclamation-triangle mr-2 text-warning"></i>Clear all scores, players, and leaderboard?
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                        <button type="button" class="btn btn-danger" id="clearAll">Yes, clear all</button>
                    </div>
                </div>
            </div>
        </div>
    </div>



    <script src="https://code.jquery.com/jquery-3.5.1.min.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js" integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/js/bootstrap.min.js" integrity="sha384-OgVRvuATP1z7JjHLkuOU7Xw704+h835Lr+6QL9UvYjZE3Ipu6Tp75j7Bh/kR0JKI" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/clipboard-js@0.3.6/clipboard.min.js"></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.4/clipboard.min.js"></script>

    <script>
        $(function() {
            $("#contestants").sortable();
            var clipboard = new ClipboardJS('.btn');
            $('ul').on('focusout', 'input', function() {
                var val = $(this).val();
                if ($(this).hasClass('player-score')) {
                    if (val.match(/[+\-\*\/]/g) != null && val.match(/[+\-\*\/]/g).length == 1) {
                        if (val.match(/\+/)) {
                            $(this).val(parseInt(val.split('+')[0]) + parseInt(val.split('+')[1]));
                        } else if (val.match(/\-/)) {
                            $(this).val(parseInt(val.split('-')[0]) - parseInt(val.split('-')[1]));
                        } else if (val.match(/\*/)) {
                            $(this).val(parseInt(val.split('*')[0]) * parseInt(val.split('*')[1]));
                        } else {
                            $(this).val(parseInt(val.split('/')[0]) / parseInt(val.split('/')[1]));
                        }
                    }
                }
                constructPlayers();
            });

            $('ul').on('keyup', 'input', function(e) {
                if ($(this).hasClass('player-score')) {
                    var v = $(this).val().match(/[0-9\+\-\*\/]/g).join('');
                    $(this).val(v);
                    var val = $(this).val();
                    if (val.match(/[+\-\*\/]/g) != null && val.match(/[+\-\*\/]/g).length == 1) {
                        if (e.which == 13) {
                            if (val.match(/\+/)) {
                                $(this).val(parseInt(val.split('+')[0]) + parseInt(val.split('+')[1]));
                            } else if (val.match(/\-/)) {
                                $(this).val(parseInt(val.split('-')[0]) - parseInt(val.split('-')[1]));
                            } else if (val.match(/\*/)) {
                                $(this).val(parseInt(val.split('*')[0]) * parseInt(val.split('*')[1]));
                            } else {
                                $(this).val(parseInt(val.split('/')[0]) / parseInt(val.split('/')[1]));
                            }
                            $(this).blur();
                            constructPlayers();
                        }
                    } else if (e.which == 13) {
                        $(this).blur();
                        constructPlayers();
                    }
                } else if (e.which == 13) {
                    $(this).blur();
                    constructPlayers();
                }
            });

            $('ul').on('click', '.up', function() {
                var v = $(this).closest('.input-group').find('input');
                v.val(parseInt(v.val()) + 1)
                constructPlayers();
            });

            $('ul').on('click', '.down', function() {
                var v = $(this).closest('.input-group').find('input');
                v.val(parseInt(v.val()) - 1)
                constructPlayers();
            });

            $('ul').on('click', '.removePlayer', function() {
                var v = $(this).closest('li');
                v.remove();
                constructPlayers();
            });

            function constructPlayers() {
                var playersStr = '';
                var playerArr = [];
                $('.player').each(function(p) {
                    var name = $(this).find('.player-name').eq(0).val();
                    var score = $(this).find('.player-score').eq(0).val();
                    var playerObj = new Object()
                    playerObj.n = name;
                    playerObj.s = score;
                    playerArr.push(playerObj)
                });
                var plrStr = '?' + encodeURIComponent(JSON.stringify(playerArr));
                window.location.href = window.location.pathname + plrStr;
                fromURL();
            }

            function fromURL() {
                $("#contestants").empty();
                var leaderboardObject = [];
                var placeLabel = ['st Place:', 'nd Place:', 'rd Place:', 'th Place:']
                if (window.location.search != '') {
                    var scoreParams = window.location.search.replace(/\?/g, '').split('&');
                    var playerParams = JSON.parse(decodeURIComponent(scoreParams));
                    var scoreAsc = playerParams.map(x => x.s).sort(function(a, b) {
                        return b - a;
                    })
                    var justNames = playerParams.map(x => x.n);
                    for (i = 0; i < scoreAsc.length; i++) {
                        var rankOb = new Object();
                        var lbl;
                        if (i < 3) {
                            lbl = placeLabel[i];
                        } else {
                            lbl = placeLabel[3];
                        }
                        var rankIndex = playerParams.map(x => x.s).indexOf(scoreAsc[i]);
                        var rankedName = playerParams.map(x => x.n)[rankIndex];
                        //rankOb.rank = (i + 1) + lbl;

                        rankOb.rank = (i + 1) + lbl;
                        rankOb.name = rankedName;
                        rankOb.score = scoreAsc[i];
                        leaderboardObject.push(rankOb);
                    }

                    $('#scoreText').val(leaderboardObject.map(x => x.rank + ' ' + x.name + ' – ' + x.score).join('\n'));
                    $('#scoreText').innerHeight(document.getElementById("scoreText").scrollHeight)
                    for (i = 0; i < playerParams.length; i++) {
                        var liHTML = `
                        <li class="list-group-item player">
                            <div class="row">
                                <i class="fas fa-grip-lines-vertical my-auto ml-2"></i>
                                <div class="col">
                                    <div class="input-group">
                                        <div class="input-group-prepend">
                                            <span class="input-group-text">Name</span>
                                        </div>
                                        <input class="form-control player-name" type="text" name="" value="${playerParams[i].n}" placeholder="Name" aria-label="Name">
                                    </div>
                                </div>

                                <div class="col">
                                    <div class="input-group">
                                        <div class="input-group-prepend">
                                            <span class="input-group-text">Score</span>
                                        </div>
                                        <input class="form-control player-score" type="text" name="" value="${playerParams[i].s}" aria-label="score">
                                        <div class="input-group-append d-flex flex-column p-0">
                                            <button class="btn btn-secondary m-0 p-0 border-0 plus-minus up">
                                                <i class="fa fa-caret-up px-2 m-auto"></i> 
                                            </button>

                                            <button class="btn btn-secondary m-0 p-0 border-0 plus-minus down">
                                                <i class="fa fa-caret-down px-2 m-auto"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                <button class="btn btn-link-dark mx-0 my-auto p-1 removePlayer">
                                    <i class="fas fa-minus-square"></i>
                                </button>
                            </div>
                        </li>
                        `;
                        $("#contestants").append(liHTML)
                    }
                }
            }

            fromURL();

            $('#addContestant').click(function() {
                newPlayer()
                $('input').eq(0).focus();
            });

            function newPlayer() {
                var newLI = `
                        <li class="list-group-item player">
                            <div class="row">
                                <i class="fas fa-grip-lines-vertical my-auto ml-2"></i>
                                <div class="col">
                                    <div class="input-group">
                                        <div class="input-group-prepend">
                                            <span class="input-group-text">Name</span>
                                        </div>
                                        <input class="form-control player-name" type="text" name="" value="" placeholder="Name" aria-label="Name">
                                    </div>
                                </div>

                                <div class="col">
                                    <div class="input-group">
                                        <div class="input-group-prepend">
                                            <span class="input-group-text">Score</span>
                                        </div>
                                        <input class="form-control player-score" type="text" name="" value="0" aria-label="score">
                                        <div class="input-group-append d-flex flex-column p-0">
                                            <button class="btn btn-secondary m-0 p-0 border-0 plus-minus up">
                                                <i class="fa fa-caret-up px-2 m-auto"></i> 
                                            </button>

                                            <button class="btn btn-secondary m-0 p-0 border-0 plus-minus down">
                                                <i class="fa fa-caret-down px-2 m-auto"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                <button class="btn btn-link-dark mx-0 my-auto p-1 removePlayer">
                                    <i class="fas fa-minus-square"></i>
                                </button>
                            </div>
                        </li>
                        `;
                $("#contestants").prepend(newLI);
            }

            $('#clearAll').click(function() {
                $('#scoreText').val('');
                $('#contestants').empty();
                $('#confirmDelete').modal('hide');
                window.location.href = window.location.pathname;
            });
        });
    </script>
</body>

</html>
